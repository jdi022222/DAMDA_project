<html layout:decorate="~{layout/layout}">
<head>
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/calendar-19/fonts/icomoon/style.css}">
    <link th:href='@{/calendar-19/fullcalendar/packages/core/main.css}' rel='stylesheet'/>
    <link th:href='@{/calendar-19/fullcalendar/packages/daygrid/main.css}' rel='stylesheet'/>
    <!-- Bootstrap CSS -->
    <!--<link rel="stylesheet" th:href="@{/calendar-19/css/bootstrap.min.css}">-->
    <!-- Style -->
    <link rel="stylesheet" th:href="@{/calendar-19/css/style.css}">
</head>
<div layout:fragment="content" class="mt-3 container justify-content-around"
     style="width: 95%; min-height: 100%; position:relative;">
    <input type="hidden" name="plan_id" th:value="${plan.id}">
    <input type="hidden" name="plan_size" th:value="${plan.size}">
    <input type="hidden" name="course" th:value="${course}">
    <button onclick="">testbutton</button>
    <!--제목과 수정, 삭제 버튼-->
    <div class="justify-content-between d-flex mb-2" style="height: 10%;">
        <h1 th:text="${plan.title}"></h1>
        <div class="d-flex w-25" style="align-items: center;">
            <a class="w-50 h-100 btn btn-info mr-2" style="align-items: center;"
               th:href="@{|/travel/design/modification/${plan.id}?order=1|}">수정
            </a>
            <a class="w-50 h-100 btn btn-danger" onclick="if(!confirm('정말로 삭제하시겠습니까?')) return false;"
               style="align-items: center;"
               th:href="@{|/travel/design/plan/delete/${plan.id}|}">삭제
            </a>
        </div>
    </div>
    <!--일차 이동 바-->
    <div class="w-100 d-flex mb-2 justify-content-start" style="height: 10%; white-space: nowrap; overflow: auto;">
        <div class="card card py-3 px-5 mr-2" th:each="courses : ${plan.courseList}">
            <a th:if="${courses.id != course.id}"
               th:href="@{|/travel/design/plan/detail/${plan.id}?order=${courses.orders}|}"
               th:text="|${courses.orders}일차|"></a>
            <a class="font-weight-bold" th:if="${courses.id == course.id}" th:text="|${courses.orders}일차|"></a>
        </div>
    </div>
    <!--여행지 코스 정보 / 지도 + 캘린터-->
    <div class="justify-content-around d-flex" style="max-height: 80%;">
        <!--        <div class="content">-->
        <div style="width: 40%;" id='calendar'></div>

        <!--            <script th:src="@{/calendar-19/js/jquery-3.3.1.min.js}"></script>-->
        <script th:src="@{/calendar-19/js/popper.min.js}"></script>
        <!--            <script th:src="@{calendar-19/js/bootstrap.min.js}"></script>-->

        <script th:src='@{/calendar-19/fullcalendar/packages/core/main.js}'></script>
        <script th:src='@{/calendar-19/fullcalendar/packages/interaction/main.js}'></script>
        <script th:src='@{/calendar-19/fullcalendar/packages/daygrid/main.js}'></script>

        <script th:inline="javascript">
            var plan_id = $('input[name=plan_id]').val();
            var plan_size = $('input[name=plan_size]').val();
            var spots = [[${spotList}]];
            var size = plan_size;
            var plan_startDate = [[${plan.startDate}]];

            var eventList = [];

            function spotsPrint() {
                //콘솔에 테스트 출력
                console.log('planId : ' + plan_id,
                    'size : ' + size,
                    'spots : ' + spots);
            }

            function addEvent() {
                var splitDate = plan_startDate.split('-');
                console.log(splitDate);
                for (var i = 0; i < plan_size; i++) {
                    var travelDate = splitDate[0] + "-" + splitDate[1] + "-" + (Number(splitDate[2]) + i);
                    //콘솔에 테스트 출력
                    console.log('title: ' + `${i + 1}일차 ` + 'start:' + travelDate + ' url:' + `/travel/design/plan/detail/${plan_id}?order=${i + 1}`);
                    //eventList에 추가
                    eventList[i] = {
                        title: `${i + 1}일차`,
                        start: travelDate.toString(),
                        url: `/travel/design/plan/detail/${plan_id}?order=${i + 1}`
                    }
                }
            }

            //캘린더 랜더링시 일부 날짜의 일차가 나오지 않는 문제
            document.addEventListener('DOMContentLoaded', function () {
                console.log('addEventListener');
                spotsPrint();
                addEvent();
                var calendarEl = document.getElementById('calendar');
                var calendar = new FullCalendar.Calendar(calendarEl, {
                    plugins: ['interaction', 'dayGrid'],
                    defaultDate: Date.now(),
                    editable: true,
                    eventLimit: true, // allow "more" link when too many events
                    events: eventList
                });
                console.log('calendar.render');

                calendar.render();
            });

        </script>

        <script th:src="@{/calendar-19/js/main.js}"></script>


        <div style="width: 50%; height: 100%;">
            <!--코스 정보-->
            <div class="card card overflow-scroll container mx-1 row" style="width:100%; max-height:100%;">
                <div class="border-bottom border-1 py-1 my-1 d-flex overflow-scroll"
                     th:each="spot, loop : ${course.spotList}">
                    <div>
                        <h3 style="align-items: center; white-space: nowrap;" href="#" th:text="|${spot.name}|"></h3>
                        <a th:href="@{|http://place.map.kakao.com/${spot.urlId}|}" style="white-space: nowrap;"
                           target="_blank">카카오 맵에서 보기</a>
                    </div>
                </div>
            </div>
            <!--지도-->
            <div class="card card container mt-2" style="width:100%; min-height:100%;">
                <div id="mapTotal" style="width:100%;height:350px;"></div>

                <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=3398f87064ef2d4f364684990589c167"></script>
                <script>
                    var MARKER_WIDTH = 33, // 기본, 클릭 마커의 너비
                        MARKER_HEIGHT = 36, // 기본, 클릭 마커의 높이
                        OFFSET_X = 12, // 기본, 클릭 마커의 기준 X좌표
                        OFFSET_Y = MARKER_HEIGHT, // 기본, 클릭 마커의 기준 Y좌표
                        OVER_MARKER_WIDTH = 40, // 오버 마커의 너비
                        OVER_MARKER_HEIGHT = 42, // 오버 마커의 높이
                        OVER_OFFSET_X = 13, // 오버 마커의 기준 X좌표
                        OVER_OFFSET_Y = OVER_MARKER_HEIGHT, // 오버 마커의 기준 Y좌표
                        SPRITE_MARKER_URL = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markers_sprites2.png', // 스프라이트 마커 이미지 URL
                        SPRITE_WIDTH = 126, // 스프라이트 이미지 너비
                        SPRITE_HEIGHT = 146, // 스프라이트 이미지 높이
                        SPRITE_GAP = 10; // 스프라이트 이미지에서 마커간 간격

                    var markerSize = new kakao.maps.Size(MARKER_WIDTH, MARKER_HEIGHT), // 기본, 클릭 마커의 크기
                        markerOffset = new kakao.maps.Point(OFFSET_X, OFFSET_Y), // 기본, 클릭 마커의 기준좌표
                        overMarkerSize = new kakao.maps.Size(OVER_MARKER_WIDTH, OVER_MARKER_HEIGHT), // 오버 마커의 크기
                        overMarkerOffset = new kakao.maps.Point(OVER_OFFSET_X, OVER_OFFSET_Y), // 오버 마커의 기준 좌표
                        spriteImageSize = new kakao.maps.Size(SPRITE_WIDTH, SPRITE_HEIGHT); // 스프라이트 이미지의 크기

                    var positionsAddress = [
                        {
                            title: '카카오',
                            address: '경기 성남시 분당구 판교역로 166 카카오 판교아지트 A동 3층'
                        },
                        {
                            title: '생태연못',
                            address: '경기 남양주시 조안면 능내리 50'
                        },
                        {
                            title: '근린공원',
                            address: '경기 남양주시 별내면 청학로68번길 40'
                        }
                    ];
                    //변환된 여행지 주소 배열
                    var positions = [  // 마커의 위치
                            // new kakao.maps.LatLng(33.44975, 126.56967),
                            // new kakao.maps.LatLng(33.450579, 126.56956),
                            // new kakao.maps.LatLng(33.4506468, 126.5707)
                            {
                                title: '카카오',
                                latlng: new kakao.maps.LatLng(33.450705, 126.570677)
                            },
                            {
                                title: '생태연못',
                                latlng: new kakao.maps.LatLng(33.450936, 126.569477)
                            },
                            {
                                title: '근린공원',
                                latlng: new kakao.maps.LatLng(33.451393, 126.570738)
                            }
                        ],
                        selectedMarker = null; // 클릭한 마커를 담을 변수

                    //주소-좌표 변환 객체
                    var geocoder = new kakao.maps.services.Geocoder();

                    var mapContainer = document.getElementById('mapTotal'), // 지도를 표시할 div
                        mapOption = {
                            center: new kakao.maps.LatLng(33.450701, 126.570667), // 지도의 중심좌표
                            level: 3 // 지도의 확대 레벨
                        };

                    var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다

                    // 지도 위에 마커를 표시합니다
                    for (var i = 0, len = positions.length; i < len; i++) {
                        var gapX = (MARKER_WIDTH + SPRITE_GAP), // 스프라이트 이미지에서 마커로 사용할 이미지 X좌표 간격 값
                            originY = (MARKER_HEIGHT + SPRITE_GAP) * i, // 스프라이트 이미지에서 기본, 클릭 마커로 사용할 Y좌표 값
                            overOriginY = (OVER_MARKER_HEIGHT + SPRITE_GAP) * i, // 스프라이트 이미지에서 오버 마커로 사용할 Y좌표 값
                            normalOrigin = new kakao.maps.Point(0, originY), // 스프라이트 이미지에서 기본 마커로 사용할 영역의 좌상단 좌표
                            clickOrigin = new kakao.maps.Point(gapX, originY), // 스프라이트 이미지에서 마우스오버 마커로 사용할 영역의 좌상단 좌표
                            overOrigin = new kakao.maps.Point(gapX * 2, overOriginY); // 스프라이트 이미지에서 클릭 마커로 사용할 영역의 좌상단 좌표

                        // 마커를 생성하고 지도위에 표시합니다
                        addMarker(positions[i], normalOrigin, overOrigin, clickOrigin);
                    }

                    // 마커를 생성하고 지도 위에 표시하고, 마커에 mouseover, mouseout, click 이벤트를 등록하는 함수입니다
                    function addMarker(position, normalOrigin, overOrigin, clickOrigin) {

                        // 기본 마커이미지, 오버 마커이미지, 클릭 마커이미지를 생성합니다
                        var normalImage = createMarkerImage(markerSize, markerOffset, normalOrigin),
                            overImage = createMarkerImage(overMarkerSize, overMarkerOffset, overOrigin),
                            clickImage = createMarkerImage(markerSize, markerOffset, clickOrigin);

                        // 마커를 생성하고 이미지는 기본 마커 이미지를 사용합니다
                        var marker = new kakao.maps.Marker({
                            map: map,
                            position: position,
                            image: normalImage
                        });

                        // 마커 객체에 마커아이디와 마커의 기본 이미지를 추가합니다
                        marker.normalImage = normalImage;

                        // 마커에 mouseover 이벤트를 등록합니다
                        kakao.maps.event.addListener(marker, 'mouseover', function() {

                            // 클릭된 마커가 없고, mouseover된 마커가 클릭된 마커가 아니면
                            // 마커의 이미지를 오버 이미지로 변경합니다
                            if (!selectedMarker || selectedMarker !== marker) {
                                marker.setImage(overImage);
                            }
                        });

                        // 마커에 mouseout 이벤트를 등록합니다
                        kakao.maps.event.addListener(marker, 'mouseout', function() {

                            // 클릭된 마커가 없고, mouseout된 마커가 클릭된 마커가 아니면
                            // 마커의 이미지를 기본 이미지로 변경합니다
                            if (!selectedMarker || selectedMarker !== marker) {
                                marker.setImage(normalImage);
                            }
                        });

                        // 마커에 click 이벤트를 등록합니다
                        kakao.maps.event.addListener(marker, 'click', function() {

                            // 클릭된 마커가 없고, click 마커가 클릭된 마커가 아니면
                            // 마커의 이미지를 클릭 이미지로 변경합니다
                            if (!selectedMarker || selectedMarker !== marker) {

                                // 클릭된 마커 객체가 null이 아니면
                                // 클릭된 마커의 이미지를 기본 이미지로 변경하고
                                !!selectedMarker && selectedMarker.setImage(selectedMarker.normalImage);

                                // 현재 클릭된 마커의 이미지는 클릭 이미지로 변경합니다
                                marker.setImage(clickImage);
                            }

                            // 클릭된 마커를 현재 클릭된 마커 객체로 설정합니다
                            selectedMarker = marker;
                        });
                    }

                    // MakrerImage 객체를 생성하여 반환하는 함수입니다
                    function createMarkerImage(markerSize, offset, spriteOrigin) {
                        var markerImage = new kakao.maps.MarkerImage(
                            SPRITE_MARKER_URL, // 스프라이트 마커 이미지 URL
                            markerSize, // 마커의 크기
                            {
                                offset: offset, // 마커 이미지에서의 기준 좌표
                                spriteOrigin: spriteOrigin, // 스트라이프 이미지 중 사용할 영역의 좌상단 좌표
                                spriteSize: spriteImageSize // 스프라이트 이미지의 크기
                            }
                        );

                        return markerImage;
                    }
                </script>
                <!--지도 끝-->
            </div>
        </div>
    </div>

    <!--    </div>-->
</div>
</html>