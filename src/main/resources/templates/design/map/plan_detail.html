<html layout:decorate="~{layout/layout}">
<head>
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/calendar-19/fonts/icomoon/style.css}">
    <link th:href='@{/calendar-19/fullcalendar/packages/core/main.css}' rel='stylesheet'/>
    <link th:href='@{/calendar-19/fullcalendar/packages/daygrid/main.css}' rel='stylesheet'/>
    <!-- Bootstrap CSS -->
    <!--<link rel="stylesheet" th:href="@{/calendar-19/css/bootstrap.min.css}">-->
    <!-- Style -->
    <link rel="stylesheet" th:href="@{/calendar-19/css/style.css}">
</head>
<div layout:fragment="content" class="mt-3 container justify-content-around"
     style="width: 95%; min-height: 100%; position:relative; margin-top:70px !important;">
    <input type="hidden" name="plan_id" th:value="${plan.id}">
    <input type="hidden" name="plan_size" th:value="${plan.size}">
    <input type="hidden" name="course" th:value="${course}">
    <!--제목과 수정, 삭제 버튼-->
    <div class="justify-content-between d-flex mb-2" style="height: 10%;">
        <h1 style="font-family: 'Jua', sans-serif; " th:text="${plan.title}"></h1>
        <div class="d-flex w-25" style="align-items: center; text-align: center;">
            <a class="w-50 h-100 btn btn-outline-secondary mr-2 fs-4" style="align-items: center; font-family: 'Jua', sans-serif;"
               th:href="@{|/travel/design/modification/basic/${plan.id}|}">
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16">
                    <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                    <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/>
                </svg>
                <br>
                기본 정보 수정
            </a>
            <a class="w-50 h-100 btn btn-outline-secondary mr-2 fs-4" style="align-items: center; font-family: 'Jua', sans-serif;"
               th:href="@{|/travel/design/modification/${plan.id}?order=1|}">
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16">
                    <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                    <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/>
                </svg>
                <br>
                수정
            </a>
            <a class="w-50 h-100 btn btn-outline-danger fs-4" onclick="if(!confirm('정말로 삭제하시겠습니까?')) return false;" style="font-family: 'Jua', sans-serif; align-items: center;"
               th:href="@{|/travel/design/plan/delete/${plan.id}|}">
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-trash3" viewBox="0 0 16 16">
                    <path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5ZM11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H2.506a.58.58 0 0 0-.01 0H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1h-.995a.59.59 0 0 0-.01 0H11Zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5h9.916Zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47ZM8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5Z"/>
                </svg>
                <br>
                삭제
            </a>
        </div>
    </div>

    <!--여행지 코스 정보 / 지도 + 캘린터-->
    <div class="justify-content-around d-flex" style="max-height: 80%;">
        <!--캘린더-->
        <div style="width: 40%; margin-left:0" id='calendar'></div>

        <!--            <script th:src="@{/calendar-19/js/jquery-3.3.1.min.js}"></script>-->
        <script th:src="@{/calendar-19/js/popper.min.js}"></script>
        <!--            <script th:src="@{calendar-19/js/bootstrap.min.js}"></script>-->

        <script th:src='@{/calendar-19/fullcalendar/packages/core/main.js}'></script>
        <script th:src='@{/calendar-19/fullcalendar/packages/interaction/main.js}'></script>
        <script th:src='@{/calendar-19/fullcalendar/packages/daygrid/main.js}'></script>

        <script th:inline="javascript">
            var plan_id = $('input[name=plan_id]').val();
            var plan_size = $('input[name=plan_size]').val();
            var spots = [[${spotList}]];
            var size = plan_size;
            var plan_startDate = [[${plan.startDate}]];

            var eventList = [];

            function spotsPrint() {
                //콘솔에 테스트 출력
                console.log('planId : ' + plan_id,
                    'size : ' + size,
                    'spots : ' + spots
                );
            }

            function addEvent() {
                var splitDate = plan_startDate.split('-');
                // console.log(splitDate);
                for (var i = 0; i < plan_size; i++) {
                    var travelDate = splitDate[0] + "-" + splitDate[1] + "-" + (Number(splitDate[2]) + i);
                    //콘솔에 테스트 출력
                    // console.log('title: ' + `${i + 1}일차 ` + 'start:' + travelDate + ' url:' + `/travel/design/plan/detail/${plan_id}?order=${i + 1}`);
                    //eventList에 추가
                    eventList[i] = {
                        title: `${i + 1}일차`,
                        start: travelDate.toString(),
                        url: `/travel/design/plan/detail/${plan_id}?order=${i + 1}`
                    }
                }
            }

            //캘린더 랜더링시 일부 날짜의 일차가 나오지 않는 문제
            document.addEventListener('DOMContentLoaded', function () {
                console.log('addEventListener');
                // spotsPrint();
                addEvent();
                var calendarEl = document.getElementById('calendar');
                var calendar = new FullCalendar.Calendar(calendarEl, {
                    plugins: ['interaction', 'dayGrid'],
                    defaultDate: Date.now(),
                    editable: true,
                    eventLimit: true, // allow "more" link when too many events
                    events: eventList
                });
                // console.log('calendar.render');

                calendar.render();
            });

        </script>

        <script th:src="@{/calendar-19/js/main.js}"></script>
        <!--캘린더 끝-->


        <div style="width: 50%; height: 100%;">
            <!--코스 정보-->
            <div class="mb-1 card card text-center">
                <h2 th:text="|${course.orders}일차|" class="fs-3" style="font-family: 'Jua', sans-serif;"></h2>
            </div>
            <div class="mb-2 d-flex bg-white shadow px-3 py-4 bg-body rounded justify-content-start" style="width:100%; max-height:100%; white-space: nowrap; overflow: auto;">
                <h3 th:if="${course.spotList.size() == 0}" class="text-center" style="font-family: 'Jua', sans-serif;">장소를 추가해 보세요!</h3>
                <div th:each="spot, loop : ${course.spotList}">
                    <a th:if="${loop.count != 1}" class="mr-2 badge badge-outline-danger">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-right-circle" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8zm15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM4.5 7.5a.5.5 0 0 0 0 1h5.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5H4.5z"/>
                        </svg>
                    </a>
                    <a class="btn btn-outline-primary mr-2" th:href="@{|http://place.map.kakao.com/${spot.urlId}|}" style="white-space: nowrap;"
                       target="_blank" th:text="|${spot.name}|"></a>
                </div>
            </div>
            <div class="card card container">
                <!--지도-->
                <div id="mapTotal" style="width:100%;height:350px;"></div>

                <script type="text/javascript"
                        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=4090d1fa0bb6c1caf12b3ec69597bf5c&libraries=services"></script>
                <script th:inline="javascript">

                    var mapContainer = document.getElementById('mapTotal'), // 지도를 표시할 div
                        mapOption = {
                            center: new kakao.maps.LatLng(33.450701, 126.570667), // 지도의 중심좌표
                            level: 7 // 지도의 확대 레벨
                        };

                    // 지도를 생성합니다
                    var map = new kakao.maps.Map(mapContainer, mapOption);

                    // 일반 지도와 스카이뷰로 지도 타입을 전환할 수 있는 지도타입 컨트롤을 생성합니다
                    var mapTypeControl = new kakao.maps.MapTypeControl();

                    // 지도에 컨트롤을 추가해야 지도위에 표시됩니다
                    // kakao.maps.ControlPosition은 컨트롤이 표시될 위치를 정의하는데 TOPRIGHT는 오른쪽 위를 의미합니다
                    map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);

                    // 지도 확대 축소를 제어할 수 있는  줌 컨트롤을 생성합니다
                    var zoomControl = new kakao.maps.ZoomControl();
                    map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

                    // 지도를 재설정할 범위정보를 가지고 있을 LatLngBounds 객체를 생성합니다
                    var bounds = new kakao.maps.LatLngBounds();



                    var positions = [];
                    spots.forEach(spot => {
                        positions.push(
                            {
                                title: spot.name,
                                addressMap: spot.address
                            }
                        );
                    });


                    // 주소-좌표 변환 객체를 생성합니다
                    var geocoder = new kakao.maps.services.Geocoder();

                    positions.forEach(function (position) {
                        // 주소로 좌표를 검색합니다
                        geocoder.addressSearch(position.addressMap, function (result, status) {

                            // 정상적으로 검색이 완료됐으면
                            if (status === kakao.maps.services.Status.OK) {

                                var coords = new kakao.maps.LatLng(result[0].y, result[0].x);


                                // 결과값으로 받은 위치를 마커로 표시합니다
                                var marker = new kakao.maps.Marker({
                                    map: map,
                                    position: coords
                                });
                                marker.setMap(map);


                                // LatLngBounds 객체에 좌표를 추가합니다
                                bounds.extend(coords);


                                // 인포윈도우로 장소에 대한 설명을 표시합니다
                                var infowindow = new kakao.maps.InfoWindow({
                                    content: '<div style="width:150px;text-align:center;padding:6px 0;">' + position.title + '</div>'
                                });
                                infowindow.open(map, marker);

                                // 지도의 중심을 결과값으로 받은 위치로 이동시킵니다
                                // map.setCenter(coords);
                                setBounds()
                            }
                        });
                    });
                    function setBounds() {
                        // LatLngBounds 객체에 추가된 좌표들을 기준으로 지도의 범위를 재설정합니다
                        // 이때 지도의 중심좌표와 레벨이 변경될 수 있습니다
                        map.setBounds(bounds);
                    }
                </script>
                <!--지도 끝-->
            </div>
        </div>
    </div>

    <!--    </div>-->
</div>
</html>